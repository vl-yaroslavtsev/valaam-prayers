<!--suppress HtmlFormInputWithoutLabel -->
<template>
	<div class="page" data-name="rites">

		<div class="navbar">
			<div class="navbar-inner sliding">
				<div class="title">Валаам</div>
				<div class="right">
					{{> "navbar-right"}}
				</div>
			</div>
		</div>

		<div class="page-content">
			<div class="page-content-tile">
			<h2 class="block">Поминовение</h2>
			<form id="formRites" class="tile" onsubmit="return false">

				<div id="formRites-riteTitle" class="block-title"></div>
				<div class="list form-list no-hairlines-md">
					<ul>
						<li class="vm-rites-rite">
							<a class="item-link smart-select smart-select-init"
								 data-open-in="popup"
								 data-close-on-select="true"
							   data-page-back-link-text="Назад"
								 data-popup-close-link-text="<i class='icon material-icons md-only'>close</i>"
								 data-page-title="Поминовение"
							   data-value-el=".vm-rites-rite .item-title">
								<select id="formRites-rite" name="rite">
									{{#each rites}}
									<optgroup label="{{name}}">
										{{#each items}}
										<!--suppress HtmlUnknownAttribute -->
										<option value="{{id}}" {{selected}}>{{name}}</option>
										{{/each}}
									</optgroup>
									{{/each}}
								</select>
								<div class="item-content">
									<div class="item-inner">
										<div class="item-title"></div>
									</div>
								</div>
							</a>
						</li>
					</ul>
				</div>

				<div class="block-title">Напишите имена</div>
				<div class="list form-list no-hairlines-md vm-rites-names">
					<ul>
						{{#each names}}
						<!--suppress HtmlUnknownAttribute -->
						<li id="rite-name-{{this[3]}}" class="{{#unless this[2]}}display-none{{/unless}}">
							<!--suppress HtmlUnknownTarget -->
							<a href="/rites-name/{{this[3]}}" class="item-link">
								<div class="item-content">
									<div class="item-inner">
										<div class="item-title">{{this[0]}}</div>
										<div class="item-after">{{this[1]}}</div>
									</div>
								</div>
							</a>
						</li>
						{{/each}}
					</ul>
					<input type="hidden" name="names" id="formRites-names">
				</div>

				<div class="block-title">Рекомендуемая сумма</div>
				<div class="list form-list no-hairlines-md ext-margin">
					<ul>
						<li class="item-content item-input item-input-outline vm-rites-donate">
							<div class="item-inner">
								<div class="item-input-wrap">
									<!--suppress HtmlUnknownAttribute -->
									<input type="number" name="donate" id="formRites-donate"
										   required validate pattern="\\d+" min="1" max="100000" maxlength="7"
										   data-error-message="Введите корректную сумму" autocomplete="false" readonly>
									<span class="input-clear-button"></span>
									<div class="item-input-info">
										Можно изменить для однодневных поминовений
									</div>
								</div>
							</div>
						</li>
					</ul>
				</div>

				<div class="block-title">Пожертвовать через</div>
				<div class="list form-list no-hairlines-md">
					<ul>
						<li class="vm-rites-payment">
							<a class="item-link smart-select smart-select-init"
								 data-open-in="popup"
								 data-close-on-select="true"
							   data-page-back-link-text="Назад"
								 data-popup-close-link-text="<i class='icon material-icons md-only'>close</i>"
								 data-page-title="Пожертвовать через"
							   data-value-el=".vm-rites-payment .item-title"
								 data-css-class="smart-select-payment">
								<select id="formRites-payment" name="payment">
									{{#each payments}}
									<!--suppress HtmlUnknownAttribute -->
									<option value="{{code}}" {{selected}} data-option-image="{{picture}}">
										{{name}}
									</option>
									{{/each}}
								</select>
								<div class="item-content">
									<div class="item-inner">
										<div class="item-title"></div>
										<div class="item-after"></div>
									</div>
								</div>
							</a>
						</li>
					</ul>
				</div>

				<div class="block-title">Телефон</div>
				<div class="list form-list no-hairlines-md ext-margin">
					<ul>
						<li class="item-content item-input item-input-outline">
							<div class="item-inner">
								<div class="item-input-wrap">
									<!--suppress HtmlUnknownAttribute -->
									<input type="tel" name="phone" value="{{phone}}" id="formRites-phone"
										   autocomplete="home phone"
										   validate pattern="(\\+7|8)?[0-9]{10}"
										   data-error-message="Введите корректный номер">
									<span class="input-clear-button"></span>
									<div class="item-input-info">
										Для списание суммы пожертвования
									</div>
								</div>
							</div>
						</li>
					</ul>
				</div>

				<div class="block-title">Электронная почта</div>
				<div class="list form-list no-hairlines-md ext-margin">
					<ul>
						<li class="item-content item-input item-input-outline">
							<div class="item-inner">
								<div class="item-input-wrap">
									<!--suppress HtmlUnknownAttribute -->
									<input type="email" name="email" value="{{email}}" id="formRites-email"
										   placeholder="e-mail@site.com" autocomplete="home email"
										   validate pattern=".+@.+\\.[a-z]{2,}"
										   data-error-message="Введите корректный адрес">
									<span class="input-clear-button"></span>
									<div class="item-input-info">
										Для уведомлений о статусе пожертвования
									</div>
								</div>
							</div>
						</li>
					</ul>
				</div>

				<div class="block">
					<!--suppress HtmlUnknownAttribute -->
					<button  id="formRites-button" @click="sendDonate" class="button button-fill button-gradient button-large">Пожертвовать</button>
					<!--
					<div class="block-footer">
						Пожертвование Христа ради на нужды обители.<br>
						Не является оплатой.
					</div>
					-->
				</div>
			</form>
			</div>
		</div>

	</div>
</template>

<!--suppress HtmlUnknownAttribute -->
<style>

	input:-webkit-autofill {
		-webkit-box-shadow: inset 0 0 0 100px #fff !important;
	}

	.smart-select-payment .item-media > img {
		height: 26px;
		border: solid 1px #eee;
	}

	.vm-rites-payment .item-after > img {
		height: 28px;
		vertical-align: middle;
	}

	input[type='number']::-webkit-outer-spin-button,
	input[type='number']::-webkit-inner-spin-button {
		-webkit-appearance: none;
	}

</style>

<!--suppress JSAnnotator, JSIgnoredPromiseFromCall -->
<script>
	export default {
		methods: {
			async sendDonate() {
				let self = this,
					app = this.$app,
					$form = this.$$('#formRites'),
					formData = app.form.convertToData('#formRites'),
					$btn = this.$$('#formRites-button')
				;

				app.input.validateInputs($form);
				let errors = $form.find('input.input-invalid');

				if(!formData.names) {
					app.methods.showMessage('Введите имя', 'bg-color-red', 3000);
					this.$router.navigate(this.$$('.vm-rites-names > ul > li:first-child > a').attr('href'));
					return;
				}

				if(errors.length)
					return;

				app.preloader.show();
				$btn.addClass('disabled');

				app.methods.storageSet('rite-payment', formData.payment);
				app.methods.storageSet('rite-phone', formData.phone);
				app.methods.storageSet('rite-email', formData.email);

				formData.return_url = 'https://valaam.ru/prayers.f7/#view-rites:/rites-status?id=%s';
				formData.valaam_gid = app.dataManager.cache.valaamGid || '';
				formData.valaam_key = '5Iz7Xi0ZxCr2vH3Ld4w6YKe7V4zAz6J0';
				// formData.valaam_debug = 'YES';

				try {
					let result = await app.request.promise.post(
						'https://valaam.ru/payments/form-rites.php',
						formData,
						'json'
					);
					if (result.status === 'error') {
						let error = [];

						error.push('Ошибка при отправки поминовения');

						['rite', 'names', 'donate', 'payment', 'email', 'error'].forEach(function(e) {
							if(result[e] !== undefined)
								error.push(result[e]);
						});

						app.methods.showMessage(result.error || error.join('<br>'), 'bg-color-red');
					} else {
						self.$router.navigate('/rites-status?id=' + (result.id || result['payment_id']));

						if (result['payment_code'] === 'apple_pay')
							// noinspection JSUnresolvedletiable
							window.webkit.messageHandlers.makeApplePay.postMessage(result);
						else if (result['payment_code'] === 'paypal') {
							self.$$(`
								<form style="display: none" action="https://www.paypal.com/cgi-bin/websc" method="post" enctype="application/x-www-form-urlencoded">
								<input type="hidden" name="cmd" value="_xclick">
								<input type="hidden" name="business" value="paypal@valaam.ru">
								<input type="hidden" name="item_name" value="Записка ${result['payment_id']}, ${result['payment_rite'].replace(/"/g, '&quot;')}">
								<input type="hidden" name="amount" value="${result['payment_summ']}">
								<input type="hidden" name="no_shipping" value="1">
								<input type="hidden" name="custom" value="${result['custom']}">
								<input type="hidden" name="currency_code" value="RUB">
								<input type="hidden" name="return" value="https://valaam.ru/prayers.f7/#view-valaam:/rites-status?id=${result['payment_id']}">
								<input type="hidden" name="cancel_return" value="https://valaam.ru/prayers.f7/#view-valaam:/rites-status?id=' + result['payment_id'] + '">
								<input type="hidden" name="notify_url" value="https://valaam.ru/payments/paypal.php?valaam_action=rites">
								<input type="hidden" name="charset" value="utf-8">
								<input type="hidden" name="rm" value="1">
								</form>
							`
							).appendTo('body').submit();
						}
						else if(result['payment']['payment_method']['type'] !== 'mobile_balance') // noinspection JSUnresolvedletiable
							document.location = result.payment.confirmation.confirmation_url;
						}
					} catch (err) {
						app.methods.showLoadError();
					} finally {
						$btn.removeClass('disabled');
						app.preloader.hide();
					}
				;
			}
		},
		on: {
			pageBeforeIn() {
				let $ss, value;
				let app = this.$app;
				let ritesConfig = app.dataManager.cache.ritesConfig;

				$ss = app.smartSelect.get('.vm-rites-rite .smart-select');
				let rite = ritesConfig.rites.find(({id}) => id == $ss.getValue());
				this.$$('#formRites-riteTitle').text(rite.name.split(' - ')[0]);
				// this.$$('#formRites-donate').prop('readonly', !rite['freeprice']) - !!! не работает !!!
				rite['freeprice'] ? this.$$('#formRites-donate').removeAttr('readonly') : this.$$('#formRites-donate').attr('readonly', true);

				$ss = app.smartSelect.get('.vm-rites-payment .smart-select');
				value = $ss.getValue();
				let img = $ss.$selectEl.find('[value="' + value + '"]').data('option-image');

				$ss.$valueEl.next().html('<img src="' + img + '" alt="">');

				if($ss.getValue() === 'mobile_balance')
					this.$$('#formRites-phone').prop('required', true).closest('div.list').show().prev().show();
				else this.$$('#formRites-phone').prop('required', false).closest('div.list').hide().prev().hide();
			},
			pageAfterIn(e, page) {
				let self = this,
					app = this.$app,
					ritesConfig = app.dataManager.cache.ritesConfig,
					$ssRite = app.smartSelect.get('.vm-rites-rite .smart-select'),
					riteValue = $ssRite.getValue(),
					$namesValue = this.$$('#formRites-names'),
					$names = this.$$('.vm-rites-names li:not(.display-none)'),
					$donateValue = this.$$('#formRites-donate'),

					rite = ritesConfig.rites.find(({id}) => id == riteValue),
					names = []
				;

				$names.forEach((value) => {
					let name = self.$$(value).find('.item-title').text().trim(),
						explanations = self.$$(value).find('.item-after').text().trim()
					;

					if(name) names.push((explanations + ' ' + name).trim());
				});
				$namesValue.val(names.join('\n'));

				let price = (names.length * rite['price']) || '';
				if(!page.router.previousRoute.route || page.router.previousRoute.route.path !== 'payment-select/')
					$donateValue.val(price);
				if(price) app.input.validateInputs(this.$$('#formRites'));

				// временно
				this.$$('#formRites-phone').attr('autocomplete', 'home phone');
				this.$$('#formRites-email').attr('autocomplete', 'home email');
			}
		},
		data() {
			let groupName = '', idx = 0, count;
			let app = this.$app;
			let ritesConfig = app.dataManager.cache.ritesConfig;
			let rites = ritesConfig.rites.reduce((result, item) => {
				let tmp = item.name.split(' - ');
				if(tmp[0] !== groupName)
					result.push({
						id: idx++,
						name: groupName = tmp[0],
						items: []
					});

				result[idx-1].items.push({
					id: item.id,
					name: tmp[1].replace(/\((\d+) /, '($1&nbsp;'),
					selected: item.id === ritesConfig['riteDefault'] ? "selected" : ""
				});
				return result;
			}, []);

			let payment = app.methods.storageGet('rite-payment');
			let payments = ritesConfig.payments.reduce((result, item) => {
				if(['apple_pay', 'google_pay'].indexOf(item.code) === -1
					|| (item.code === 'apple_pay' && app.data.canApplePay)
					|| (item.code === 'google_pay' && app.device.android)
				)
					result.push({
						id: item.id,
						code: item.code,
						name: item.name,
						picture: item.picture,
						selected: item.code === payment ? "selected" : ""
					});
				return result;
			}, []);

			let names = [];

			if(app.data.debug) {
				names.push(['Иоанна', 'раба Божия', true, app.utils.id()]);
				// names.push(['Иулии', 'рабы Божией', true, app.utils.id()]);
				// names.push(['Софии', '', true, app.utils.id()]);
			}

			if(names.length < ritesConfig.maxNames)
				names.push(['', '', true, app.utils.id()]);

			for(idx = 0, count = ritesConfig.maxNames - names.length; idx < count; idx++)
				names.push(['', '', false, app.utils.id()]);

			return {
				rites: rites,
				payments: payments,
				names: names,
				//
				phone: app.methods.storageGet('rite-phone'),
				email: app.methods.storageGet('rite-email')
			};
		}
	}
</script>
