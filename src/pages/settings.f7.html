<template>

<div class="page page-white">

	<div class="navbar">
		<div class="navbar-bg"></div>
		<div class="navbar-inner sliding">
			<div class="left">
				<a href="#" class="link back">
					<i class="icon icon-back"></i>
					<span class="">Назад</span>
				</a>
			</div>
			<div class="title"></div>
		</div>
	</div>

	<div class="page-content">
		<h2 class="block">Настройки</h2>
		<div class="block">
			<p>Применяются к разделам «Молитвослов», «Календарь»,
				«Валаам» и «Поминовение».</p>
		</div>
		<div class="list media-list no-hairlines">
			<ul>
				<li>
					<div class="item-content">
						<div class="item-media">
						 	<i class="icon material-icons disabled">wifi_off</i>
					 	</div>
						<div class="item-inner">
							<div class="item-title-row">
								<div class="item-title">
								 	Кэширование
							 	</div>
								<div class="item-after">
									<label class="toggle toggle-init disabled">
										<input type="checkbox" checked>
										<span class="toggle-icon"></span>
									</label>
								</div>
							</div>
							<div class="item-text">
							Cтраницы молитвослова и календаря, которые Вы посещали ранее,
							будут доступны без сети Интернет.
							</div>
						</div>
					</div>
				</li>
				<li>
					<a href="/settings/download/"
						 class="item-link item-content">
						<div class="item-media">
						 	<i class="icon material-icons  disabled">get_app</i>
					 	</div>
						<div class="item-inner">
							<div class="item-title-row">
								<div class="item-title">Скачать молитвослов и календарь
								</div>
							</div>
							<div class="item-text">
							Для использования без сети Интернет.
							</div>
						</div>
					</a>
				</li>
				<li>
					<a href="/settings/fonts/" class="item-link item-content">
						<div class="item-media">
						 	<i class="icon material-icons  disabled">title</i>
					 	</div>
						<div class="item-inner">
							<div class="item-title-row">
								<div class="item-title">Шрифты
								</div>
							</div>
							<div class="item-text">Для чтений молитвослова и календаря</div>
						</div>
					</a>
				</li>
				<li>
					<div class="item-content">
						<div class="item-media">
							<i class="icon material-icons  disabled">brightness_3</i>
						</div>
						<div class="item-inner">
							<div class="item-title-row">
								<div class="item-title">
									Ночной режим
								</div>
								<div class="item-after">
									<label class="toggle toggle-init"
											 @toggle:change="onThemeChange">
										<input type="checkbox" {{#if themeDark}}checked{{/if}}>
										<span class="toggle-icon"></span>
									</label>
								</div>
							</div>
						</div>
					</div>
				</li>
				<li>
					<div class="item-content">
						<div class="item-media">
							<i class="icon material-icons  disabled">fullscreen</i>
						</div>
						<div class="item-inner">
							<div class="item-title-row">
								<div class="item-title">
									Полноэкранный режим
								</div>
								<div class="item-after">
									<label class="toggle toggle-init"
												 @toggle:change="onStatusbarChange">
										<input type="checkbox" {{#if hideStatusbar}}checked{{/if}}>
										<span class="toggle-icon"></span>
									</label>
								</div>
							</div>
							<div class="item-text">Скрывать строку состояния в режиме чтения</div>
						</div>
					</div>
				</li>
				<li>
					<a class="item-link smart-select smart-select-init"
						 data-open-in="popover"
						 data-close-on-select="true"
						 data-css-class="smart-select-icon-round"
						 data-popup-close-link-text="<i class='icon material-icons'>close</i>">
						<select id="select-bg"
										@change="onBgChange">
							{{#each bgItems}}
							<!--suppress HtmlUnknownAttribute -->
								<option value="{{value}}" {{selected}}
												data-option-image="{{image}}"
												data-option-icon="{{icon}}">
									{{name}}
							</option>
							{{/each}}
						</select>
						<div class="item-content">
							<div class="item-media">
							 	<i class="icon material-icons disabled">colorize</i>
						 	</div>
							<div class="item-inner">
								<div class="item-title-row">
									<div class="item-title">Фон</div>
								</div>
								<div class="item-text">Для чтений молитвослова и календаря</div>
							</div>
						</div>
					</a>
				</li>
				<li>
					<a class="item-link item-content"  @click="testFitures">
						<div class="item-media">
						 	<i class="icon material-icons  disabled">info</i>
					 	</div>
						<div class="item-inner">
							<div class="item-title-row">
								<div class="item-title">Техническая информация
								</div>
							</div>
						</div>
					</a>
				</li>
			</ul>
		</div>
	</div>
</div>
</template>
<style scoped>
	.list .item-media {
		min-width: auto;
	}

	.smart-select .item-after > img {
		height: 28px;
		vertical-align: middle;
	}

	.link-download {
		 --f7-list-item-border-color: transparent;
	}

	.color-green {
		color: rgb(17,184,18);
	}
</style>
<!--suppress JSAnnotator -->
<script>
	import settingsManager from '../js/settings-manager.js';
	import downloadManager from '../js/download/manager.js';

	const BACKGROUND_ITEMS = [
		{
			name: 'Белый',
			icon: 'icon-white',
			value: 'rgb(255,255,255)'
		},
		{
			name: 'Светло-жёлтый',
			icon: 'icon-yellow',
			value: 'rgb(255,245,209)'
		},
		{
			name: 'Кремовый',
			image: './images/bg-cream.jpg',
			value: 'url(./images/bg-cream.jpg)'
		},
		{
			name: 'Старая бумага',
			image: './images/bg-papirus.jpg',
			value: 'url(./images/bg-papirus.jpg)'
		}
	];

	let app, $el;
	export default {
		data() {
			app = this.$app;

			let style = getBgStyle();

			//console.log(style);
			return {
				themeDark: document.querySelector('html').classList.contains('theme-dark'),
				hideStatusbar: settingsManager.get('hideStatusbar'),
				bgItems: BACKGROUND_ITEMS.map((item) => {
					item.selected = (item.value === style.bgColor ||
												   item.value === style.bgImage) ? 'selected' : '';
					return item;
				})
			};
		},
		methods: {
			onThemeChange(event) {
				let toggle = event.target.querySelector('input');
				this.themeDark = toggle.checked;

				settingsManager.apply({
					themeDark: this.themeDark
				});
			},
			onStatusbarChange(event) {
				let toggle = event.target.querySelector('input');
				this.hideStatusbar = toggle.checked;

				settingsManager.save({
					hideStatusbar: this.hideStatusbar
				});
			},
			onBgChange(event) {
				let value = event.target.value;
				let state = {
					bgColor: value.includes('rgb') ? value : '',
					bgImage: value.includes('url') ? value : ''
				};

				//console.log('onBgChange', this);

				settingsManager.save(state);
			},
			testFitures() {
				downloadManager.testFitures();
			}
	 	},
		on: {
			pageInit(e, page) {
				$el = this.$el;
			},
			pageBeforeIn(e, page) {
			},
			pageBeforeRemove() {
				settingsManager.apply();
			}
		}
	};

	function getBgStyle() {
		let style = window.getComputedStyle(app.root.find('#test-slavonic')[0]);
		let data = {};

		data.bgColor = style.backgroundColor
				.replace(/\s/g, '');
		data.bgImage = style.backgroundImage
				.replace(/["']/g,'')
				.replace(location.origin,'')
				.replace(location.pathname,'./');

		//console.log('getBgStyle', data);
		return data;
	}

</script>
