<template>
<div class="popup elevation-6"
		 id="settings-text-popup">
	<div class="view view-init">
		<div class="page page-white">
			<div class="page-content">
				<div class="block-header">
					<p>Настройка текста</p>
				</div>
				<div class="list no-hairlines no-margin">
					<ul>
						<li>
							<a class="item-link smart-select smart-select-init"
								 id="smart-select-color-theme"
								 data-open-in="popover"
								 data-close-on-select="true"
								 data-css-class="smart-select-icon-round"
								 data-popup-close-link-text="<i class='icon material-icons'>close</i>"
								 data-value-el="#smart-select-color-theme .item-title-inner">
								<select id="select-color-theme"
												@change="onStyleChange">
									{{#each colorThemes}}
									<!--suppress HtmlUnknownAttribute -->
										<option value="{{value}}"
													  {{#js_if "this.value == @root.colorTheme"}}selected{{/js_if}}
														data-option-image="{{image}}"
														data-option-icon="{{icon}}">
											{{name}}
									</option>
									{{/each}}
								</select>
								<div class="item-content">
									<div class="item-media">
										<i class="icon material-icons md-only disabled">colorize</i>
									</div>
									<div class="item-inner">
										<div class="item-title">
											<div class="item-header">Цветовая схема</div>
											<span class="item-title-inner"></span>
										</div>
									</div>
								</div>
							</a>
						</li>
						<li>
							<div class="item-content">
								<div class="item-media">
									<i class="icon material-icons md-only disabled">translate</i>
								</div>
								<div class="item-inner">
									<div class="item-title">
										<div class="item-header">Язык</div>
										<span class="item-title-inner">{{language.name}}</span>
									</div>
								</div>
							</div>
					  </li>
						{{#js_if "this.language.id == 'churchslavonic'"}}
						<li>
							<a class="item-link smart-select smart-select-init"
								 id="smart-select-font-family-cs"
								 data-open-in="popover"
								 data-close-on-select="true"
								 data-popup-close-link-text="<i class='icon material-icons md-only'>close</i>"
								 data-value-el="#smart-select-font-family-cs .item-title-inner">
								<select id="select-font-family-cs"
												@change="onStyleChange">
									{{#each csFonts}}
										<option value="{{this}}"
														{{#js_if "this == @root.csFontFamily"}}selected{{/js_if}}>
							 				{{this}}
										</option>
									{{/each}}
								</select>
								<div class="item-content">
									<div class="item-media">
										<i class="icon material-icons md-only disabled">text_format</i>
									</div>
									<div class="item-inner">
										<div class="item-title">
											<div class="item-header">Шрифт</div>
											<span class="item-title-inner"></span>
										</div>
									</div>
								</div>
							</a>
						</li>
						<li>
							<div class="item-content">
								<div class="item-media">
									<i class="icon material-icons md-only disabled">format_size</i>
								</div>
								<div class="item-inner">
									<div class="item-title">
										<div class="item-header">Размер шрифта</div>
										<div class="stepper stepper-small stepper-init"
												 id="stepper-font-size-cs"
												 data-autorepeat="true"
												 data-autorepeat-dynamic="true"
												 data-min="15"
												 data-max="60"
												 data-step="0.5"
												 data-decimal-point="1"
												 data-value="{{csFontSize}}"
												 @stepper:change="onStyleChange">
											<div class="stepper-button-minus"></div>
											<div class="stepper-value"></div>
											<div class="stepper-button-plus"></div>
										</div>
									</div>
								</div>
							</div>
						</li>
						<li>
							<div class="item-content">
								<div class="item-media">
									<i class="icon material-icons md-only disabled">format_line_spacing</i>
								</div>
								<div class="item-inner">
									<div class="item-title">
										<div class="item-header">Высота строки</div>
										<div class="stepper stepper-small stepper-init"
												 id="stepper-line-height-cs"
												 data-autorepeat="true"
												 data-autorepeat-dynamic="true"
												 data-min="0.7"
												 data-max="2"
												 data-step="0.05"
												 data-value="{{csLineHeight}}"
												 @stepper:change="onStyleChange"
												 >
											<div class="stepper-button-minus"></div>
											<div class="stepper-value"></div>
											<div class="stepper-button-plus"></div>
										</div>
									</div>
								</div>
							</div>
						</li>
						<li>
							<div class="item-content">
								<div class="item-media">
									<i class="icon material-icons md-only disabled">format_bold</i>
								</div>
								<div class="item-inner">
									<div class="item-title">
										Жирный
									</div>
									<div class="item-after">
										<label class="toggle toggle-init"
													 id="toggle-font-weight-cs"
													 @toggle:change="onStyleChange">
											<input type="checkbox" {{#js_if "this.csFontWeight >= 700"}}checked{{/js_if}}>
											<span class="toggle-icon"></span>
										</label>
									</div>
								</div>
							</div>
						</li>
						{{/js_if}}
						{{#js_if "this.language.id == 'slavonic'"}}
						<li>
							<a class="item-link smart-select smart-select-init"
								 id="smart-select-font-family-sl"
								 data-open-in="popover"
								 data-close-on-select="true"
								 data-popup-close-link-text="<i class='icon material-icons'>close</i>"
								 data-value-el="#smart-select-font-family-sl .item-title-inner">
								<select id="select-font-family-sl"
												@change="onStyleChange">
										{{#each slFonts}}
											<option value="{{this}}"
														  {{#js_if "this == @root.slFontFamily"}}selected{{/js_if}}>
												{{this}}
											</option>
										{{/each}}
								</select>
								<div class="item-content">
									<div class="item-media">
										<i class="icon material-icons md-only disabled">text_format</i>
									</div>
									<div class="item-inner">
										<div class="item-title">
											<div class="item-header">Шрифт</div>
											<span class="item-title-inner"></span>
										</div>
									</div>
								</div>
							</a>
						</li>
						<li>
							<div class="item-content">
								<div class="item-media">
									<i class="icon material-icons md-only disabled">format_size</i>
								</div>
								<div class="item-inner">
									<div class="item-title">
										<div class="item-header">Размер шрифта</div>
										<div class="stepper stepper-small stepper-init"
												 id="stepper-font-size-sl"
												 data-autorepeat="true"
												 data-autorepeat-dynamic="true"
												 data-min="10"
												 data-max="60"
												 data-step="0.5"
												 data-value="{{slFontSize}}"
												 @stepper:change="onStyleChange">
											<div class="stepper-button-minus"></div>
											<div class="stepper-value"></div>
											<div class="stepper-button-plus"></div>
										</div>
									</div>
								</div>
							</div>
						</li>
						<li>
							<div class="item-content">
								<div class="item-media">
									<i class="icon material-icons md-only disabled">format_line_spacing</i>
								</div>
								<div class="item-inner">
									<div class="item-title">
										<div class="item-header">Высота строки</div>
										<div class="stepper stepper-small stepper-init"
												 id="stepper-line-height-sl"
												 data-autorepeat="true"
												 data-autorepeat-dynamic="true"
												 data-min="0.7"
												 data-max="2"
												 data-step="0.05"
												 data-value="{{slLineHeight}}"
												 @stepper:change="onStyleChange"
												 >
											<div class="stepper-button-minus"></div>
											<div class="stepper-value"></div>
											<div class="stepper-button-plus"></div>
										</div>
									</div>
								</div>
							</div>
						</li>
						<li>
							<div class="item-content">
								<div class="item-media">
									<i class="icon material-icons md-only disabled">format_bold</i>
								</div>
								<div class="item-inner">
									<div class="item-title">
										Жирный
									</div>
									<div class="item-after">
										<label class="toggle toggle-init"
													 id="toggle-font-weight-sl"
													 @toggle:change="onStyleChange">
											<input type="checkbox"
														 {{#js_if "this.slFontWeight >= 700"}}checked{{/js_if}}>
											<span class="toggle-icon"></span>
										</label>
									</div>
								</div>
							</div>
						</li>
						{{/js_if}}
						<li>
							<a class="item-link smart-select smart-select-init"
								 id="smart-select-text-align"
								 data-open-in="popover"
								 data-close-on-select="true"
								 data-popup-close-link-text="<i class='icon material-icons'>close</i>"
								 data-value-el="#smart-select-text-align .item-title-inner">
								<select id="select-text-align"
												@change="onStyleChange">
										{{#each textAligns}}
											<option value="{{id}}"
															{{#js_if "this.id ===  @root.textAlign"}}selected{{/js_if}}>
												{{name}}
											</option>
										{{/each}}
								</select>
								<div class="item-content">
									<div class="item-media">
										<i class="icon material-icons md-only disabled">format_align_left</i>
									</div>
									<div class="item-inner">
										<div class="item-title">
											<div class="item-header">Выравнивать текст по</div>
											<span class="item-title-inner"></span>
										</div>
									</div>
								</div>
							</a>
						</li>
						<li>
							<div class="item-content">
								<div class="item-media">
									<i class="icon material-icons md-only disabled">format_indent_increase</i>
								</div>
								<div class="item-inner">
									<div class="item-title">
										Поля страниц
									</div>
									<div class="item-after">
										<label class="toggle toggle-init"
													 id="toggle-text-padding"
													 @toggle:change="onStyleChange">
											<input type="checkbox"
														 {{#js_if "!this.noPadding"}}checked{{/js_if}}>
											<span class="toggle-icon"></span>
										</label>
									</div>
								</div>
							</div>
						</li>
					 </ul>
				</div>
				<div class="list no-margin">
					<ul>
						<li>
							<a href="#"
								 class="item-link item-content popup-close"
								  @click="tutorial">
								<div class="item-media">
									<i class="icon material-icons">help_outline</i>
								</div>
								<div class="item-inner">
									<div class="item-title">Режим обучения</div>
								</div>
							</a>
						</li>
					</ul>
				</div>
				<div class="list no-margin">
					<ul>
						<li>
							<!--
							data-view="#view-main"
							data-view-tab="true"
							-->
							<a href="/settings"
								 data-view="current"
								 class="item-link item-content popup-close">
								<div class="item-media">
									<i class="icon material-icons">settings</i>
								</div>
								<div class="item-inner">
									<div class="item-title">Общие настройки</div>
								</div>
							</a>
						</li>
					</ul>
				</div>
			</div>
		</div>
	</div>
</div>
</template>
<style scoped>
 	#settings-text-popup{{this}} {
		width: 68%;
		height: auto;
		max-width: 300px;
		/* max-height: calc(100vh - 5px - var(--f7-navbar-height) - var(--f7-safe-area-top)); */
		left: auto;
		right: 5px;
		top: calc(var(--f7-navbar-height) + var(--f7-safe-area-top));
		border-radius: var(--f7-popover-border-radius);
	}

	.list .item-media {
		min-width: auto;
	}

	.block-title {
		margin-top: 2em;
		/* font: 18px/24px Geometria; */
		text-transform: none;
		/* font-weight: 500; */
	}

	@media (min-height: 630px) and (min-width: 630px) {
		#settings-text-popup{{this}} {
			max-width: 400px;
		}
	}
</style>
<!--suppress JSAnnotator -->
<script>
	import {Dom7 as $$} from 'framework7';
	import settingsManager from '../js/settings-manager.js';

	const SLAVONIC_FONTS = [
		'Circe',
		'Roboto',
		'PT Sans',
		'Arial',
		'PT Serif',
		'Noto Serif',
		'Times New Roman'
	];

	const CHURCHSLAVONIC_FONTS = [
		'Triodion',
		'Orthodox',
		'Hirmos',
		'Akathistos',
		'Pochaevsk',
		'StaroUspenskaya',
		'Ostrog'
	];

	const TEXT_ALIGN_OPTIONS = [
		{
			id: 'justify',
			name: 'Ширине',
		},
		{
			id: 'left',
			name: 'Левому краю'
		},
		{
			id: 'right',
			name: 'Правому краю'
		},
		{
			id: 'center',
			name: 'Центру'
		}
	];

	const COLOR_THEMES = [
		{
			name: 'День',
			icon: 'icon-light',
			value: 'light'
		},
		{
			name: 'Ночь',
			icon: 'icon-dark',
			value: 'dark'
		},
		{
			name: 'Кремовая',
			image: './images/bg-cream.jpg',
			value: 'cream'
		},
		{
			name: 'Сепия',
			icon: 'icon-sepia',
			value: 'sepia'
		},
		{
			name: 'Сепия контраст',
			icon: 'icon-sepia-contrast',
			value: 'sepia-contrast'
		},
		{
			name: 'Жёлтая',
			icon: 'icon-yellow',
			value: 'yellow'
		},
		{
			name: 'Серая',
			icon: 'icon-grey',
			value: 'grey'
		}
	];

	let app;
	export default {
		data() {
			app = this.$app;

			let data = getTextStyle();

			data.textAligns  = TEXT_ALIGN_OPTIONS;
			data.slFonts     = SLAVONIC_FONTS;
			data.csFonts     = CHURCHSLAVONIC_FONTS;
			data.colorThemes = COLOR_THEMES;

			return data;
		},
		methods: {
			tutorial() {
				let $page = app.root.find('.view.tab-active').find('.page-current');
				$page[0].f7Component.tutorial();
			},
			onStyleChange(event, value) {
				// console.log('onStyleChange', arguments);
				let newState = {};
				let target = event.target;
				switch (target.id) {
					case 'stepper-font-size-cs':
						newState.csFontSize = (+value).toFixed(1);
						break;

					case 'stepper-font-size-sl':
						newState.slFontSize = (+value).toFixed(1);
						break;

					case 'stepper-line-height-cs':
						newState.csLineHeight = (+value).toFixed(2);
						break;

					case 'stepper-line-height-sl':
						newState.slLineHeight = (+value).toFixed(2);
						break;

					case 'select-font-family-cs':
						newState.csFontFamily = target.value;
						break;

					case 'select-font-family-sl':
						newState.slFontFamily = target.value;
						break;

					case 'toggle-font-weight-sl':
						newState.slFontWeight = target.querySelector('input').checked ? "700" : "400";
						break;

					case 'toggle-font-weight-cs':
						newState.csFontWeight = target.querySelector('input').checked ? "700" : "400";
						break;

					case 'select-text-align':
						newState.textAlign = target.value;
						break;

					case 'toggle-text-padding':
						newState.noPadding = !target.querySelector('input').checked;
						break;

					case 'select-color-theme':
					 	newState.colorTheme = target.value;
						break;
				}

				this.$setState(newState);
				settingsManager.apply(newState);

				if (['select-font-family-cs', 'select-font-family-sl'].includes(target.id)) {
					document.fonts.load(`20px ${target.value}`).then(() => {
						app.emit('settingsTextChanged');
					});
				} else {
					app.emit('settingsTextChanged');
				}
			}
	 	},
		on: {
		  popupInit(event, route, popup) {
				// console.log('popup init', this, arguments);
				popup.$backdropEl.addClass('popup-backdrop-transparent');

				app.on('popoverOpen', popoverOpen);
				app.on('popoverClosed', popoverClosed);
		  },
			popupOpen(event) {
				// console.log('popup open', arguments);
				let $el = this.$el;
				setTimeout(() => {
					let style = window.getComputedStyle($el[0]);
					let height = $el.find('.page-content')[0].scrollHeight + 10;

					let maxHeight = window.innerHeight
											 - 5
											 - parseInt(style.getPropertyValue('--f7-navbar-height'))
											 - parseInt(style.getPropertyValue('--f7-safe-area-top'));

					$el.css({
						height: (height > maxHeight ? maxHeight : height) + 'px'
					});
				}, 0);
		  },
			popupOpened(event) {
				// console.log('popup opened', arguments);
				updateLineHeightStepper(this.$el, this.language);
		  },
			popupClose(event) {
				// console.log('popup close', arguments);
			},
			popupClosed(event) {
				// console.log('popup closed', arguments);
			},
		  popupBeforeRemove(event, route, popup) {
		    // console.log('popup before remove', arguments);
				settingsManager.apply();
				popup.$backdropEl.removeClass('popup-backdrop-transparent');
				app.off('popoverOpen', popoverOpen);
				app.off('popoverClosed', popoverClosed);
		  },
		}
	};

	function getTextStyle() {
		let $page = app.root.find('.view.tab-active').find('.page-current');
		let $block = $page.find('.tab-active > .block-strong.inset');
		let language = $page[0].f7Component.language;

		if (!$block.length) {
			$block = $page.find('.block-strong.inset');
		}

		let blockStyle = window.getComputedStyle($block[0]);

		let colorTheme = 'light';
		for (let className of $$('html')[0].classList.values()) {
			if (/^text-theme-/i.test(className)) {
				colorTheme = className.replace('text-theme-', '');
				break;
			}
		}

		let style = {
			language,
			colorTheme,
			textAlign: blockStyle.textAlign,
			noPadding: parseInt(blockStyle.getPropertyValue('--f7-block-padding-horizontal')) <= 5
		};

		if (language.id === 'slavonic') {
			Object.assign(style, {
				slFontFamily: blockStyle.fontFamily.split(',')[0].replace(/["']/g, ''),
				slFontSize: parseFloat(blockStyle.fontSize).toFixed(1),
				slLineHeight: (parseFloat(blockStyle.lineHeight) / parseFloat(blockStyle.fontSize)).toFixed(2),
				slFontWeight: blockStyle.fontWeight
			});

		} else if (language.id === 'churchslavonic') {
			Object.assign(style, {
				csFontFamily: blockStyle.fontFamily.split(',')[0].replace(/["']/g, ''),
				csFontSize: parseFloat(blockStyle.fontSize).toFixed(1),
				csLineHeight: (parseFloat(blockStyle.lineHeight) / parseFloat(blockStyle.fontSize)).toFixed(2),
				csFontWeight: blockStyle.fontWeight
			});
		}

		//console.log('style', style);

		return style;
	}

	function updateLineHeightStepper($el, language) {
		let stepper = app.stepper.get($el.find(`#stepper-line-height-${language.code}`)[0]);
		stepper.params.formatValue = (value) => (+value).toFixed(2);
	}

	function popoverOpen(popover) {
		// console.log('popoverOpen', arguments);
		popover.$backdropEl.addClass('popover-backdrop-transparent');
	}

	function popoverClosed(popover) {
		// console.log('popoverClosed', arguments);
		popover.$backdropEl.removeClass('popover-backdrop-transparent');
	}
</script>
