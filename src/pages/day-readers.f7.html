<template>
	<div class="page page-with-tabs-subnavbar" data-name="day-ereaders-{{id}}">

		<div class="navbar navbar-large navbar-transparent">
			<div class="navbar-bg"></div>
			<div class="navbar-inner sliding">
				<div class="left">
					<a href="#" class="link back">
						<i class="icon icon-back"></i>
						<span class="">Назад</span>
					</a>
				</div>
				<div class="title">{{name}}</div>
				<div class="title-large">
	        <div class="title-large-text">{{name}}</div>
	      </div>
				<div class="right">
					<a class="link smart-select smart-select-init"
						 data-open-in="popover"
						 data-close-on-select="true">
						<select id="select-language"
										@change="selectLenguage">
							<option value="tab-churchslavonic"
											{{#js_if "this.tabId == 'tab-churchslavonic'"}}selected{{/js_if}}>
									Церковнославянский
							</option>
							<option value="tab-slavonic"
										  {{#js_if "this.tabId == 'tab-slavonic'"}}selected{{/js_if}}>
									Русский
							</option>
						</select>
						<i class="icon material-icons md-only">translate</i>
					</a>
					{{#if searchMode}}
					<!--<a class="link popup-close">Закрыть</a>-->
					{{else}}
						{{> "navbar-right"}}
					{{/if}}
				</div>
			</div>
		</div>

		<div class="page-content">
			<div class="subnavbar tabs-subnavbar">
				<div class="subnavbar-inner">
					<div class="segmented segmented-raised">
						<a class="button tab-link" href="#" data-tab=".page[data-name='day-ereaders-{{id}}'] #tab-churchslavonic">Церковнославянский</a>
						<a class="button tab-link" href="#" data-tab=".page[data-name='day-ereaders-{{id}}'] #tab-slavonic">Русский</a>
					</div>
				</div>
			</div>

			<div class="tabs">
				<div class="tab" id="tab-churchslavonic">
					<div class="block block-strong inset churchslavonic-ereader">{{churchslavonicText}}</div>
				</div>
				<div class="tab" id="tab-slavonic">
					<div class="block block-strong inset slavonic-ereader text-content">{{slavonicText}}</div>
				</div>
			</div>
		</div>

	</div>
</template>

<style scoped>
	/* .navbar-bg {
		height: var(--f7-navbar-height);
	} */
</style>
<!--suppress JSAnnotator -->
<script>
	import navbarLargeMixin from './navbar-large-mixin.js';

	export default {
		data() {
			let dayCode = this.$route.params.id,
				readerId = (this.$route.context && this.$route.context.actionId) || this.$route.params.readerId,
				readerData = {},
				text;

			readerData = Object.assign(
				{},
				this.day.readers.find(({id}) => id === readerId)
			);

			text = readerData.text.split('\n');
			text = text.filter((a) => a.startsWith('#c#'));
			text = text.map((a) => {
				return a.replace(/#c#(\d+:\d+)/, '<span class="text-color-red">$1</span>');
			});
			readerData.churchslavonicText = text.join('<br>');

			text = readerData.text.split('\n');
			text = text.filter((a) => a.startsWith('#r#'));
			text = text.map((a) => {
				return a
					.replace(/#r#(\d+:\d+)/, '<span class="text-color-red">$1</span>')
					.replace(/\[(Зач\. \d+)\]/g, '[<span class="text-color-red">$1</span>]')
					.replace(/_(.*?)_/g, '<i>$1</i>')
					;
			});
			readerData.slavonicText = text.join('<br>');

			readerData.searchMode = this.$route.query.mode === 'search';

			return readerData;
		},
		methods: {
			selectLenguage({target}) {
				app.tab.show(this.$el.find('#' + target.value));
			}
		},
		on: {
			pageInit(e, page) {
				let tabId = app.methods.storageGet('ereaders-text-tab') ||
									  'tab-slavonic';
				app.tab.show(page.$el.find('#' + tabId));

				page.$el.find('.tabs').on('tab:show', (event) => {
					this.tabId = event.target.id;
					app.methods.storageSet('ereaders-text-tab', event.target.id);
				});
		  }
		},
		mixins: [navbarLargeMixin]
	};
</script>
