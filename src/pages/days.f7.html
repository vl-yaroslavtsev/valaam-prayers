<!--suppress HtmlUnknownTarget -->
<template>
	<div class="page">

		<div class="navbar">
			<div class="navbar-bg"></div>
			<div class="navbar-inner sliding">
				<div class="left">
					<a href="#" class="link back">
						<i class="icon icon-back"></i>
						<span class="">Назад</span>
					</a>
				</div>
				<div class="title">{{#if searchMode}}Поиск{{else}}Календарь{{/if}}</div>
				<div class="right">
					{{#if searchMode}}
					<!--<a class="link popup-close">Закрыть</a>-->
					{{else}}
					<a href="/days/{{dayPrev}}" data-reload-current="true" class="link"><i
							class="icon icon-back"></i></a>
					<a href="/days/{{dayNext}}" data-reload-current="true" class="link"><i
							class="icon icon-forward"></i></a>
					{{> "navbar-right"}}
					{{/if}}
				</div>
			</div>
		</div>

		<div class="page-content">
			<h3 class="block">{{day.subtitle}}</h3>
			<h2 class="block">{{day.title}}</h2>
			<div class="tile">
				<div class="block day-saints-icon">
					<div class="item-media media-obj no-bg">
						<img class="media-obj-img lazy"
							 data-src="https://valaam.ru{{day.picture}}"
							 data-src-db="{{day.picture}}"
							 data-srcorig="https://valaam.ru{{day.picture_3x}}"
							 title="{{day.picture_desc}}">
							 <!-- data-srcset="{{day.picture_srcset}}"
	 						sizes="60vw" -->
					</div>
					<div class="item-text text-color-gray">{{day.picture_desc}}</div>
				</div>
				<div class="block day-saints-text">
					{{day.text}}
				</div>

				<div class="block-title">Евангельские Чтения</div>
				<div class="block margin-top-half">{{day.readers_text}}</div>
				<!--
				<div class="list no-hairlines-md">
					<ul>
						{{#each day.readers}}
						<li>
							<a href="/days/{{@root.dayCode}}/readers/{{id}}" class="item-link item-content">
								<div class="item-inner">
									<div class="item-title">{{name}}</div>
								</div>
							</a>
						</li>
						{{/each}}
					</ul>
				</div>
				-->

				{{#if day.prayers.text}}
				<div class="block-title">Мысли на каждый день года</div>
				<div class="list no-hairlines-md">
					<ul>
						<li>
							<a href="/days/{{dayCode}}/thoughts" class="item-link item-content">
								<div class="item-inner">
									<div class="item-title">{{day.prayers.picture_desc}}</div>
								</div>
							</a>
						</li>
					</ul>
				</div>
				{{/if}}

				{{#if day.parabel}}
				<div class="block-title">Притча дня</div>
				<div class="list media-list no-hairlines-md">
					<ul>
						<li>
							<a href="/days/{{dayCode}}/parabel" class="item-link item-content">
								<div class="item-inner">
									<div class="item-title-row">
										<div class="item-title">{{day.parabel_short}}</div>
									</div>
								</div>
							</a>
						</li>
					</ul>
				</div>
				{{/if}}

				<div class="block-title">Богослужебные указания</div>
				<div class="list no-hairlines-md">
					<ul>
						<li>
							<a href="/days/{{dayCode}}/instructions" class="item-link item-content">
								<div class="item-inner">
									<div class="item-title">{{day.full_title}}</div>
								</div>
							</a>
						</li>
					</ul>
				</div>

				<div class="block-title">Тропари и кондаки</div>
				<div class="list no-hairlines-md">
					<ul>
						{{#if day.prayers.daily_tak}}
						<li>
							<a href="/prayers/text/{{day.prayers.daily_tak.id}}" class="item-link item-content">
								<div class="item-inner">
									<div class="item-title">{{day.prayers.daily_tak.name}}</div>
								</div>
							</a>
						</li>
						{{/if}}
						{{#each day.prayers.items}}
						<li>
							<a href="/days/{{@root.dayCode}}/prayers/{{id}}" class="item-link item-content">
								<div class="item-inner">
									<div class="item-title">{{name}}</div>
								</div>
							</a>
						</li>
						{{/each}}
					</ul>
				</div>
			</div>
		</div>
	</div>
</template>
<!--suppress HtmlUnknownAttribute -->
<style scoped>
	.links-list a {
		white-space: normal;
	}
	div.block-title {
		margin-top: 32px;
		/*white-space: normal;*/
	}
	.list .item-title {
		white-space: normal;
		display: -webkit-box;
		-webkit-line-clamp: 2;
		-webkit-box-orient: vertical;
	}

	.date-section p {
		margin: 0;
	}

	.date-section p.weekday {
		font-size: 24px;
		margin: 0;
	}

	em {
		color: red;
		font-style: normal;
	}

	.day-saints-text a {
		/*text-decoration: none;*/
	}

	.day-saints-text strong {
	}

	.day-saints-text em {
		font-style: normal;
		font-size: 1.25em;
		color: red;
	}

	.day-saints-text img {
		height: 20px;
		vertical-align: middle;
		margin-top: -3px;
		margin-right: 3px;
	}

	.day-saints-icon  {
		display: flex;
	}

	.day-saints-icon .item-media {
		max-width: 65%;
		height: 250px;
		flex-shrink: 0;
	}

	.day-saints-icon img {
		max-width: 100%;
		width: auto;
	}

	.day-saints-icon .item-text {
		padding-left: 10px;
		align-self: center;
		font-size: 14px;
		flex-shrink: 1;
	}

	.day-saints-icon .item-text:first-letter {
		text-transform: uppercase;
	}
</style>
<!--suppress JSAnnotator -->
<script>
	import {format, parse, addDays, subDays} from '../js/date-utils.js';
	import {upperFirst} from 'lodash-es';

	let app;

	export default {
		on: {
			pageAfterIn(e, page) {
				// this.$router.navigate('/days/20190428', {});
			}
		},
		data() {
			app = this.$app;
			let dataManager = app.dataManager,
					prayers = dataManager.cache.prayers,
					dayCode = this.$route.params.id,
					day = Object.assign({}, this.day);

			day.text = /*marked*/(day.text)
				.replace(/href="E(\d+)"/g, 'href="/prayers/text/$1"')
			;

			day.picture_desc = app.methods.hyphenate(day.picture_desc);

			day.readers_text = day.readers_text.replace(/\^(\d+)/g, '<sup>$1</sup>');

			day.parabel_short = day.parabel
				.replace(/<\/?[^>]+>/gi, '')
				.slice(0, 300)
			;

			if (day.prayers.daily_tak) {
				day.prayers.daily_tak = prayers.e.find(
					(e) => e.id === day.prayers.daily_tak
				);
			}

			let oldstyleDate = subDays(parse(day.code), 13);
			let newstyleDate = parse(day.code);
			let dayOfWeek = upperFirst(format(newstyleDate, 'EEEE'));

			day.subtitle = format(oldstyleDate, 'd MMMM по старому стилю');
			day.title = format(newstyleDate, `d MMMM yyyy г. ${dayOfWeek}`);
			day.full_title = format(oldstyleDate, 'd MMMM / ') +
											 day.title;

			return {
				dayCode,
				day,
				dayPrev: format(subDays(parse(day.code), 1)),
				dayNext: format(addDays(parse(day.code), 1)),
				searchMode: this.$route.query.mode === 'search'
			};
		}
	};
</script>
