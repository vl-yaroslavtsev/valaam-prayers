<template>
	<div class="page" data-name="{{id}}">

		<div class="navbar">
			<div class="navbar-bg"></div>
			<div class="navbar-inner sliding">
				{{#if name}}
				<div class="left">
					<a href="#" class="link back">
						<i class="icon icon-back"></i>
						<span>Назад</span>
					</a>
				</div>
				{{/if}}
				<div class="title">Валаам</div>
				<div class="right">
					{{> "navbar-right"}}
				</div>

				<div class="{{#if showSearchbar}}subnavbar{{else}}display-none{{/if}}">
					<form class="searchbar searchbar-init searchbar-transparent"
								data-search-container="[data-name='{{id}}'] .virtual-list"
								data-search-item="li"
								data-search-in=".item-title">
						<div class="searchbar-inner">
							<div class="searchbar-input-wrap">
								<input type="search" placeholder="Поиск в разделе"/>
								<i class="searchbar-icon"></i>
								<span class="input-clear-button"></span>
							</div>
							<!-- <span class="searchbar-disable-button">Отмена</span> -->
						</div>
					</form>
      	</div>
			</div>
		</div>

		<div class="page-content">
			{{#if name}}
			<h2 class="block">{{name}}</h2>
			{{else}}
			<h2 class="block">{{title}}</h2>
			{{/if}}

			<div class="list simple-list list-transparent searchbar-not-found no-hairlines-md">
				<ul>
					<li>Увы, ничего не нашлось.</li>
				</ul>
			</div>

			<div class="list ucase-list virtual-list searchbar-found">
			  <!-- keep it empty -->
			</div>
		</div>

	</div>
</template>
<style>
</style>
<!--suppress JSAnnotator -->
<script>
	import {sortBy} from 'lodash-es';
	import {Dom7 as $$} from 'framework7';
	let app;

	export default {
		data() {
			app = this.$app;

			return {
				loading: true,
				name: false,
				showSearchbar: false,
				title: this.$router.view.name,
				loadPromise: loadData.call(this)
			};
		},
		on: {
			async pageInit(e, page) {
				this.virtualList = app.virtualList.create({
				  // List Element
				  el: page.$el.find('.virtual-list'),
				  // Pass array with items
				  items: [1,2,3,4,5,6],
				  // Custom search function for searchbar
				  searchAll(query, items) {
						//debugger;
				    var found = [];
				    for (var i = 0; i < items.length; i++) {
				      if (items[i].name.toLowerCase().indexOf(query.toLowerCase()) >= 0 || query.trim() === '') found.push(i);
				    }
				    return found; //return array with mathced indexes
				  },
				  // List item Template7 template
				  itemTemplate: `
						{{#if this.id}}
						<li key="{{this.id}}">
							<a href="{{href}}" class="item-link item-content">
								<div class="item-inner">
									<div class="item-title">{{name}}</div>
								</div>
							</a>
						</li>
						{{else}}
						<li key="{{this}}">
							<div class="item-link item-content">
								<div class="item-inner">
									<div class="item-title skeleton-block"
											 style="width:{{js "5 + Math.round(Math.random() * 15)"}}ch;"></div>
								</div>
							</div>
						</li>
						{{/if}}
					`,
				  // Item height
				  height:  $$(window).width() < 768 ? 52 : 83
				});

				let {items, state} = await this.loadPromise;
				state.showSearchbar = (items.length > 30);

				this.$setState(state);
				if (state.showSearchbar) {
					this.$el.addClass('page-with-subnavbar');
				}
				this.virtualList.replaceAllItems(items);
    	},
			pageBeforeRemove(e, page) {
				this.virtualList.destroy();
  		},
		}
	};

	async function loadData() {
		try {
			let prayers = await app.dataManager.get('prayers');
			let data = handleData.call(this, prayers);
			app.emit('mainPageLoaded', 'prayers', this);

			return data;
		} catch (err) {
			app.methods.showLoadError();
			throw err;
		}
	}

	function handleData(prayers) {
		let sectionId = this.$route.params.sectionId || "0";
		let state = {};
		let items = [];

		prayers.s.forEach((data) => {
			if (data.parent === sectionId) {
				items.push(Object.assign(data, {
					href: '/prayers/' + data.id
				}));
			}
			if (data.id === sectionId && data.parent !== "0") {
				// prayerData.name = data.name;
				Object.assign(state, {id: `PR${data.id}` , name: data.name});
			}
		});

		prayers.e
			.filter(({parent}) => parent === sectionId)
			.forEach((data) => {
				items.push(Object.assign(data, {href: '/prayers/text/' + data.id}));
			});

		state.loading = false;
		items = sortBy(items, ['sort', 'name']);

		return {
			items,
			state
		};
	}
</script>
