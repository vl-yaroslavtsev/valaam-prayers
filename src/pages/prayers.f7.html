<template>
	<div class="page" data-name="prayers-{{id}}">

		<div class="navbar navbar-large navbar-transparent">
			<div class="navbar-bg"></div>
			<div class="navbar-inner sliding">
				{{#if canGoBack}}
				<div class="left">
					<a href="#" class="link back">
						<i class="icon icon-back"></i>
						<span>Назад</span>
					</a>
				</div>
				{{/if}}
				<div class="title">{{name}}</div> <!-- Валаам -->
				<div class="title-large">
	        <div class="title-large-text">{{name}}
						{{#if lastReading}}
						<div class="title-large-subtext">
							<div class="title-large-info">
								{{lastReading.path}}<br>
								Страница: {{lastReading.page}} из {{lastReading.pages}}
							</div>
							<div class="title-large-button">
								<a class="button button-round button-outline button-raised"
									 @click="readMore()">Читать</a>
							</div>
						</div>
						{{/if}}
					</div>
				</div>
				<div class="right">
					{{> "navbar-right"}}
				</div>

				<div class="{{#if showSearchbar}}subnavbar{{else}}display-none{{/if}}">
					<form class="searchbar searchbar-init searchbar-transparent"
								data-search-container=".page[data-name='prayers-{{id}}'] .virtual-list"
								data-search-item="li"
								data-search-in=".item-title">
						<div class="searchbar-inner">
							<div class="searchbar-input-wrap">
								<input type="search" placeholder="Поиск в разделе"/>
								<i class="searchbar-icon"></i>
								<span class="input-clear-button"></span>
							</div>
							<!-- <span class="searchbar-disable-button">Отмена</span> -->
						</div>
					</form>
      	</div>
			</div>
		</div>

		<div class="page-content">
			<!--
			{{#if name}}
			<h2 class="block">{{name}}</h2>
			{{else}}
			<h2 class="block">{{title}}</h2>
			{{/if}}
			-->

			{{#if description}}
			<div class="block text-white">{{description}}</div>
			{{/if}}

			<div class="list simple-list list-transparent searchbar-not-found no-hairlines-md">
				<ul>
					<li>Увы, ничего не нашлось.</li>
				</ul>
			</div>

			<div key="virtual-list" class="list ucase-list virtual-list searchbar-found">
			  <!-- keep it empty -->
			</div>
		</div>

	</div>
</template>
<style scoped>
	.navbar-large-collapsed .subnavbar:not([style^="transform:"]) {
    background: url(images/bg.jpg) 0 0/100% auto no-repeat;
    background-position: 0 calc(0px	- var(--f7-navbar-height) - var(--f7-safe-area-top));
	}

	.title-large-subtext {
		display:flex;
		flex-direction: row;
		justify-content: space-between;

		margin-top: var(--f7-block-margin-vertical);

		color: var(--f7-navbar-link-color);
		font-size: var(--f7-navbar-font-size);
		line-height: 1.5;
	}

	.title-large-info {
	}
	.title-large-button {
		--f7-button-text-color: var(--f7-navbar-link-color);
		--f7-button-outline-border-color: var(--f7-navbar-link-color);
	}
</style>
<!--suppress JSAnnotator -->
<script>
	import {sortBy} from 'lodash-es';
	import {Dom7 as $$} from 'framework7';
	import dataManager from '../js/data/manager.js';
	import db from '../js/data/db.js';
	import { isMobile } from '../js/utils/utils.js';
	import navbarLargeMixin from './navbar-large-mixin.js';

	const PRAYERS_SID = "842"; // Полный молитвослов
	const LITURGICAL_BOOKS_SID = "937"; // Богослужебные книги

	let app;

	export default {
		data() {
			app = this.$app;

			return {
				loading: true,
				name: this.$router.view.name,
				showSearchbar: false,
				loadPromise: loadData.call(this)
			};
		},
		methods: {
			readMore() {
				this.$router.navigate(`/prayers/text/${this.lastReading.id}`);
			}
		},
		mixins: [navbarLargeMixin],
		on: {
			async pageInit(e, page) {
				this.virtualList = app.virtualList.create({
					// List Element
					el: page.$el.find('.virtual-list'),
					// Pass array with items
					items: [1,2,3,4,5,6],
					// Custom search function for searchbar
					searchAll(query, items) {
						//console.log('searchAll', query, items);
						//debugger;
						var found = [];
						for (var i = 0; i < items.length; i++) {
							if (items[i].name.toLowerCase().indexOf(query.toLowerCase()) >= 0 ||
									query.trim() === '') found.push(i);
						}
						return found; //return array with mathced indexes
					},
					// List item Template7 template
					itemTemplate: `
						{{#if this.id}}
						<li key="{{this.id}}">
							<a href="{{href}}" class="item-link item-content">
								<div class="item-inner">
									<div class="item-title">{{name}}</div>
								</div>
							</a>
						</li>
						{{else}}
						<li key="{{this}}">
							<div class="item-link item-content">
								<div class="item-inner">
									<div class="item-title skeleton-block"
											 style="width:{{js "5 + Math.round(Math.random() * 15)"}}ch;"></div>
								</div>
							</div>
						</li>
						{{/if}}
					`,
					// Item height
					height: isMobile() ? 52 : 83
				});

				let {items, state} = await this.loadPromise;

				this.virtualList.replaceAllItems(items);

				state.showSearchbar = (items.length > 30);
				this.$setState(state, () => {
					this.$el.trigger('navbar-render');
				});
				if (state.showSearchbar) {
					this.$el.addClass('page-with-subnavbar');
				}
			},
			async pageBeforeIn(e, page) {
				if (page.router.history.length > 1) {
					this.canGoBack = true;
				}
				await updateLastReading(this);
				this.$update(() => {
					this.$el.trigger('navbar-render');
				});
			},
			pageBeforeRemove(e, page) {
				this.virtualList.destroy();
			},
		}
	};

	async function loadData() {
		try {
			let prayers = await dataManager.get('prayers');
			let data = await handleData.call(this, prayers);
			app.emit('mainPageLoaded', 'prayers', this);

			return data;
		} catch (err) {
			app.methods.showLoadError();
			throw err;
		}
	}

	async function updateLastReading(state) {
		if (!state.bookRoot) return;

		let readings = await db.read_history.getAllFromIndex('by-book-id', state.id);
		if (!readings.length) return;

		let lastReading = sortBy(readings, ['date']).pop();
		let path = lastReading.path.concat(lastReading.name);
		path.shift();
		Object.assign(state, {
			lastReading: {
				id: lastReading.id,
				path: path.join(' • '),
				page: lastReading.page,
				pages: lastReading.pages,
			}
		});
	}

	async function handleData(prayers) {
		let sectionId = this.$route.params.sectionId || "0";
		let state = {};
		let items = [];

		prayers.s.forEach((data) => {
			if (data.parent === sectionId) {
				items.push(Object.assign(data, {
					href: '/prayers/' + data.id
				}));
			}

			// Временно: добавляем Богослужебные книги (937) Полный молитвослов (842)
			if (sectionId === PRAYERS_SID && data.id === LITURGICAL_BOOKS_SID) {
				items.push(Object.assign(data, {
					href: '/prayers/' + data.id
				}));
			}

			if (data.id === sectionId && data.parent !== "0") {
				// prayerData.name = data.name;
				Object.assign(state, {
					id: data.id ,
					name: data.name,
					bookRoot: data.book_root,
					description: data.description
				});
			}
		});

		await updateLastReading(state);

		prayers.e
			.filter(({parent}) => parent === sectionId)
			.forEach((data) => {
				items.push(Object.assign(data, {href: '/prayers/text/' + data.id}));
			});

		state.loading = false;
		items = sortBy(items, ['sort', 'name']);

		return {
			items,
			state
		};
	}
</script>
