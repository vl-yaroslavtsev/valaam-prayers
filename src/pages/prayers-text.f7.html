<template>
	<div class="page page-with-tabs-subnavbar read-mode"
			 data-name="prayers-text-{{id}}">

		<div class="navbar">
			<div class="navbar-bg"></div>
			<div class="navbar-inner sliding">
				<div class="left">
					<a href="#" class="link back">
						<i class="icon icon-back"></i>
						<span class="">Назад</span>
					</a>
				</div>
				<div class="title"></div>
				<div class="right">
					{{#if twoText}}
					<a class="link smart-select smart-select-init"
						 data-open-in="popover"
						 data-close-on-select="true">
						<select id="select-language"
										@change="selectLanguage">
							{{#each languages}}
								<option value="{{id}}"
											  {{#js_if "this.id == @root.language.id"}}selected{{/js_if}}>
									{{name}}
							</option>
							{{/each}}
						</select>
						<i class="icon material-icons md-only">translate</i>
					</a>
					{{/if}}
					{{> "navbar-right"}}
				</div>
				<div class="navbar-extra">
					<div class="navbar-extra-subtitle">{{parentPath}}</div>
		      <div class="navbar-extra-title">{{name}}</div>
				</div>
			</div>
		</div>

		{{> "read-mode-toolbar"}}

		<div class="page-content">
			<!-- hide-navbar-on-scroll hide-toolbar-on-scroll -->
			<!--
			{{#if parentName}}
			<h3 class="block">{{parentName}}</h3>
			{{/if}}
			{{#if name}}
			<h2 class="block">{{name}}</h2>
			{{/if}}

			{{#if twoText}}
			<div class="subnavbar tabs-subnavbar">
				<div class="subnavbar-inner">
					<div class="segmented segmented-raised">
						<a class="button tab-link" href="#" data-tab=".page[data-name='prayers-text-{{id}}'] #tab-churchslavonic">Церковнославянский</a>
						<a class="button tab-link" href="#" data-tab=".page[data-name='prayers-text-{{id}}'] #tab-slavonic">Русский</a>
					</div>
				</div>
			</div>
			{{/if}}
			-->

			{{#js_if "this.text || this.picture" }}
			<div class="block block-strong inset text-content">
				{{#if picture}}
				<p>
					<img class="lazy"
							 data-src="https://valaam.ru{{picture}}"
							 data-src-db="{{picture}}"
							 data-src-full="https://valaam.ru{{picture_3x}}"
					>
				</p>
				{{/if}}
				{{text}}
			</div>
			{{/js_if}}

			<div class="tabs">
				{{#if churchslavonicText}}
				<div class="tab {{#unless twoText}}tab-active{{/unless}}" id="tab-churchslavonic">
					<div class="block block-strong inset churchslavonic">{{churchslavonicText}}</div>
				</div>
				{{/if}}
				{{#if slavonicText}}
				<div class="tab {{#unless twoText}}tab-active{{/unless}}" id="tab-slavonic">
					<div class="block block-strong inset slavonic text-content">{{slavonicText}}</div>
				</div>
				{{/if}}
			</div>
		</div>
		<read-mode-tutorial id="read-mode-tutorial-{{id}}"></read-mode-tutorial>
	</div>
</template>
<!--suppress HtmlUnknownAttribute -->
<style scoped>
	.churchslavonic em {
		font-family: var(--f7-font-family);
		font-size: 0.85em;
	}

	img {
		width: 100%;
	}
</style>
<!--suppress JSAnnotator -->
<script>
	import favoriteManager from '../js/favorite-manager.js';
	import dataManager from '../js/data/manager.js';
	import readModeMixin from './read-mode-mixin.js';
	import { prayersBookId, prayersPath } from '../js/data/utils.js';
  import { languages, langById } from '../js/data/languages.js';

	let app;

	export default {
		data() {
			app = this.$app;
			let prayers = dataManager.cache.prayers,
				prayer = this.prayer,
				data = {
					id: prayer.id,
					name: prayer.name,
					languages,
					textSettings: true,
					searchMode: this.$route.query.mode === 'search'
				};
			this.title = data.searchMode ? 'Поиск' : this.$router.view.name;

			handleData(data, prayers, prayer);

			return data;
		},
		methods: {
			toggleFavorite() {
				let isFavorite = !this.isFavorite;

				if (isFavorite) {
					favoriteManager.add(this.id, 'prayer-e');
				} else {
					favoriteManager.remove(this.id);
				}

				this.$setState({isFavorite});

				return false;
			},
			selectLanguage({target}) {
				this.language = langById(target.value);
				app.tab.show(this.$el.find('#tab-' + this.language.id));
			}
		},
		mixins: [readModeMixin],
		on: {
			pageInit(e, page) {
				//await this.dataPromise;
				//if (this.loading)
				if (this.twoText) {
					app.tab.show(page.$el.find('#tab-' + this.language.id));
					this.$update();
				}

				page.$el.find('.tabs').on('tab:show', (event) => {
					this.language = langById(event.target.id.replace('tab-', ''));
					app.methods.storageSet('prayers-text-language', this.language.id);
					if (this.readMode) {
						this.readMode.update();
					} else {
						this.$update();
					}
				});

		  }
		}
	};

	function handleData(data, prayers, prayer) {
		let path = prayersPath(prayer.id);
		if (prayersBookId(prayer.id)) {
			data.parentPath = path.join(' • ');
		} else {
			data.parentPath = path.pop();
		}

		data.parent = prayer.parent;
		data.text = /*marked*/(prayer.text)
			.replace(/href="(https?|mailto|tel):/g, 'class="external" href="$1:')
		;
		data.picture = prayer.picture;
		data.picture_3x = prayer.picture_3x;
		data.churchslavonicText = prayer.churchslavonic_text;
		data.slavonicText = prayer.slavonic_text;
		data.twoText = data.churchslavonicText && data.slavonicText;

		let list = prayers.e.filter(({parent}) => parent === prayer.parent);
		let index = list.findIndex(({id}) => id === prayer.id);
		let prevId = index > 0 ? list[index - 1].id : null;
		data.prevUrl = `/prayers/text/${prevId}`;
		data.prevUrlActive = !!prevId;
		let nextId = index < list.length - 1 ? list[index + 1].id : null;
		data.nextUrl = `/prayers/text/${nextId}`;
		data.nextUrlActive = !!nextId;

		data.isFavorite = favoriteManager.has(data.id);

		let langId;
		if (data.twoText) {
			langId = app.methods.storageGet('prayers-text-language') || 'slavonic';
		} else if (data.churchslavonicText) {
			langId = 'churchslavonic';
		} else {
			langId = 'slavonic';
		}
		data.language = langById(langId);
	}
</script>
