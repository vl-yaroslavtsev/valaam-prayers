<template>
	<div class="page page-with-tabs-subnavbar" data-name="{{id}}">

		<div class="navbar">
			<div class="navbar-bg"></div>
			<div class="navbar-inner sliding">
				<div class="left">
					<a href="#" class="link back">
						<i class="icon icon-back"></i>
						<span class="">Назад</span>
					</a>
				</div>
				<div class="title">{{title}}</div>
				<div class="right">
					<!--<a href="#" class="link churchslavonic">Ц</a>-->
					<!--<a href="#" class="link slavonic">Р</a>-->
					{{#if searchMode}}
					<!--<a class="link popup-close">Закрыть</a>-->
					{{else}}
					<a href="/prayers/text/{{prevId}}"
						 data-reload-current="true"
						 class="link {{#unless prevId}}disabled{{/unless}}">
						<i class="icon icon-back"></i>
					</a>
					<a href="/prayers/text/{{nextId}}"
						 data-reload-current="true"
						 class="link {{#unless nextId}}disabled{{/unless}}">
						<i class="icon icon-forward"></i>
					</a>
				 		{{> "navbar-right"}}
					{{/if}}
				</div>
			</div>
		</div>

		<div class="page-content hide-navbar-on-scroll hide-toolbar-on-scroll">
			{{#if parentName}}
			<h3 class="block">{{parentName}}</h3>
			{{/if}}
			{{#if name}}
			<h2 class="block">{{name}}</h2>
			{{/if}}

			{{#if twoText}}
			<div class="subnavbar tabs-subnavbar">
				<div class="subnavbar-inner">
					<div class="segmented segmented-raised">
						<a class="button tab-link" href="#tab-churchslavonic">Церковнославянский</a>
						<a class="button tab-link" href="#tab-slavonic">Русский</a>
					</div>
				</div>
			</div>
			{{/if}}

			{{#js_if "this.text || this.picture" }}
			<div class="block block-strong inset text-content">
				{{#if picture}}
				<p>
					<img class="lazy"
							 data-src="https://valaam.ru{{picture}}"
							 data-src-db="{{picture}}"
							 data-srcorig="https://valaam.ru{{picture_3x}}"
					>
				</p>
				{{/if}}
				{{text}}
			</div>
			{{/js_if}}

			<div class="tabs">
				{{#if churchslavonicText}}
				<div class="tab {{#unless twoText}}tab-active{{/unless}}" id="tab-churchslavonic">
					<div class="block block-strong inset churchslavonic">{{churchslavonicText}}</div>
				</div>
				{{/if}}
				{{#if slavonicText}}
				<div class="tab {{#unless twoText}}tab-active{{/unless}}" id="tab-slavonic">
					<div class="block block-strong inset slavonic text-content">{{slavonicText}}</div>
				</div>
				{{/if}}
			</div>
		</div>
	</div>
</template>
<!--suppress HtmlUnknownAttribute -->
<style scoped>
	.churchslavonic em {
		font-family: var(--f7-font-family);
		font-size: 0.85em;
	}

	.navbar-bg {
		height: var(--f7-navbar-height);
	}

	img {
		width: 100%;
	}
</style>
<!--suppress JSAnnotator -->
<script>
	import favoriteManager from '../js/favorite-manager.js';
	let app;

	export default {
		data() {
			app = this.$app;
			let prayers = app.dataManager.cache.prayers,
					prayer = this.prayer,
					data = {
						searchMode: this.$route.query.mode === 'search'
					};
			data.title = data.searchMode ? 'Поиск' : this.$router.view.name;

			handleData(data, prayers, prayer);

			return data;
		},
		methods: {
			toggleFavorite() {
				let isFavorite = !this.isFavorite;

				if (isFavorite) {
					favoriteManager.add(this.id, 'prayer-e');
				} else {
					favoriteManager.remove(this.id);
				}

				this.$setState({isFavorite});

				return false;
			}
		},
		on: {
			async pageInit(e, page) {
				await this.dataPromise;
				//if (this.loading)
				let tabId = app.methods.storageGet('prayers-text-tab') ||
									  'tab-slavonic';
				if (this.twoText) {
						app.tab.show(page.$el.find('#' + tabId));
				}

				page.$el.find('.tabs').on('tab:show', (event) => {
					app.methods.storageSet('prayers-text-tab', event.target.id);
				});
		  }
		}
	};

	function handleData(data, prayers, prayer) {
		let parentSection = prayers.s.find(({id}) => id === prayer.parent);

		data.id = prayer.id;
		data.name = prayer.name;
		if (parentSection) {
				data.parentName = parentSection.name;
		}

		data.text = /*marked*/(prayer.text)
			.replace(/href="(https?|mailto|tel):/g, 'class="external" href="$1:')
		;
		data.picture = prayer.picture;
		data.picture_3x = prayer.picture_3x;
		data.churchslavonicText = prayer.churchslavonic_text;
		data.slavonicText = prayer.slavonic_text;
		data.twoText = data.churchslavonicText && data.slavonicText;

		let list = prayers.e.filter(({parent}) => parent === prayer.parent);
		let index = list.findIndex(({id}) => id === prayer.id);
		data.prevId = index > 0 ? list[index - 1].id : null;
		data.nextId = index < list.length - 1 ? list[index + 1].id : null;

		data.isFavorite = favoriteManager.has(data.id);
	}
</script>
