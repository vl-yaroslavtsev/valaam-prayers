<template>

<div class="page page-white">

	<div class="navbar">
		<div class="navbar-bg"></div>
		<div class="navbar-inner sliding">
			<div class="left">
				<a href="#" class="link back">
					<i class="icon icon-back"></i>
					<span class="">Назад</span>
				</a>
			</div>
			<div class="title"></div>
		</div>
	</div>

	<div class="page-content">
		<h2 class="block">Молитвослов офлайн</h2>
		<div class="block">
			<p>Молитвослов, Библия, календарь, жития святых,
				духовная литература для работы без сети Интернет.</p>
		</div>

		{{#if new.length}}
		<div class="block-header">
			<p>Доступные для скачивания</p>
		</div>
		<div class="list media-list no-hairlines">
			<ul>
				{{#each new}}
				<download-list-item
					id="download-item-{{id}}"
					data-item="{{id}}">
				</download-list-item>
				{{/each}}
			</ul>
		</div>
		{{/if}}

		{{#if loaded.length}}
		<div class="block-header">
			<p>Загруженные</p>
		</div>
		<div class="list media-list no-hairlines">
			<ul>
				{{#each loaded}}
				<download-list-item
					id="download-item-{{id}}"
					data-item="{{id}}">
				</download-list-item>
				{{/each}}
			</ul>
		</div>
		{{/if}}
	</div>
</div>
</template>
<style scoped>
	.block-title {
		margin-top: 2em;
		/* font: 18px/24px Geometria; */
		text-transform: none;
		/* font-weight: 500; */
	}

	.item-content .progressbar {
		--f7-progressbar-height: 3px;
		position: absolute;
		bottom: 1px;
		left: 0;
		right: 0;
	}
</style>
<!--suppress JSAnnotator -->
<script>
	import downloadManager from '../js/download/manager.js';

	const downloadItemIds = [
		'calendar',
		'calendar_icons',
		'prayers',
		'liturgical_books',
		'spiritual_books',
	];

	let app, $el;

	export default {
		data() {
			app = this.$app;
			app.preloader.show();

			return {
				all: downloadItemIds.map(id => downloadManager.get(id)),
				new: [],
				loaded: [],
			};
		},
		methods: {
			updateState() {
				this.$setState({
					loaded: this.all.filter(({state:{status}}) => status === 'fresh'),
					new: this.all.filter(({state:{status}}) => status !== 'fresh'),
				});
			},
			onDownloadItemChanged({state, changed}) {
				if (changed.status) {
					this.updateState();
				}
			}
	 	},
		on: {
			async pageInit(e, page) {
				await downloadManager.refreshAll();

				this.all.forEach(
					item => item.on('state:changed', this.onDownloadItemChanged)
				);
				this.updateState();
				app.preloader.hide();
			},
			pageBeforeRemove() {
				this.all.forEach(item => item.off('state:changed', this.onDownloadItemChanged));
			}
		}
	};
</script>
