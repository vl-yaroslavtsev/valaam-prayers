<!--suppress HtmlUnknownTarget -->
<template>
	<div class="page">
		<div class="navbar navbar-collapse">
			<div class="navbar-bg"></div>
			<div class="navbar-inner sliding">
				<div class="left">
					<a href="#" class="link back">
						<i class="icon icon-back"></i>
						<span class="">Назад</span>
					</a>
				</div>
				<div class="title">{{day.title}}</div>
				<div class="right">
					<a href="/days/{{dayPrev}}" data-reload-current="true" class="link"><i
							class="icon icon-back"></i></a>
					<a href="/days/{{dayNext}}" data-reload-current="true" class="link"><i
							class="icon icon-forward"></i></a>
					{{> "navbar-right"}}
				</div>
			</div>
		</div>

		<div class="page-content">
			<div class="page-title">
				<div class="page-subtitle">
					{{day.subtitle}}
				</div>
				{{day.title}}
			</div>

			<div class="tile">
				<div class="block day-saints-icon">
					<div class="item-media media-obj">
						<img class="media-obj-tile lazy"
							 data-src="{{day.picture}}">
						<img class="media-obj-img lazy"
							 data-src="{{day.picture}}"
							 data-src-full="{{day.picture_full}}"
							 title="{{day.picture_desc}}">
							 <!-- data-srcset="{{day.picture_srcset}}"
	 						sizes="60vw" -->
					</div>
					<div class="item-text text-color-gray">{{day.picture_desc}}</div>
				</div>
				<div class="block day-saints-text">
					{{day.text}}
				</div>

				<div class="block-title">Порядок чтений, согласно календарю</div>
				<div class="block margin-top-half">{{day.readers_text}}</div>

				{{#if day.prayers.text}}
				<div class="block-title">Мысли на каждый день года</div>
				<div class="list no-hairlines-md">
					<ul>
						<li>
							<a href="/days/{{dayCode}}/thoughts" class="item-link item-content">
								<div class="item-inner">
									<div class="item-title">{{day.prayers.picture_desc}}</div>
								</div>
							</a>
						</li>
					</ul>
				</div>
				{{/if}}

				{{#if day.parabel}}
				<div class="block-title">Притча дня</div>
				<div class="list media-list no-hairlines-md">
					<ul>
						<li>
							<a href="/days/{{dayCode}}/parabel" class="item-link item-content">
								<div class="item-inner">
									<div class="item-title-row">
										<div class="item-title">{{day.parabel_short}}</div>
									</div>
								</div>
							</a>
						</li>
					</ul>
				</div>
				{{/if}}

				{{#if day.synaxarion}}
				<div class="block-title">Cинаксарь</div>
				<div class="block-header">Объяснение праздника Триоди составленное Никифором Ксанфопулом
				</div>
				<div class="list media-list no-hairlines-md">
					<ul>
						<li>
							<a href="/prayers/text/{{day.synaxarion.id}}" class="item-link item-content">
								<div class="item-inner">
									<div class="item-title-row">
										<div class="item-title">{{day.synaxarion.name}}</div>
									</div>
								</div>
							</a>
						</li>
					</ul>
				</div>
				{{/if}}

				<div class="block-title">Богослужебные указания</div>
				<div class="list no-hairlines-md">
					<ul>
						<li>
							<a href="/days/{{dayCode}}/instructions" class="item-link item-content">
								<div class="item-inner">
									<div class="item-title">{{day.full_title}}</div>
								</div>
							</a>
						</li>
					</ul>
				</div>

				<div class="block-title">Тропари и кондаки</div>
				<div class="list no-hairlines-md">
					<ul>
						{{#if day.prayers.taks.length}}
							{{#each day.prayers.taks}}
							<li>
								<a href="/prayers/text/{{id}}" class="item-link item-content">
									<div class="item-inner">
										<div class="item-title">{{name}}</div>
									</div>
								</a>
							</li>
							{{/each}}
						{{/if}}
					</ul>
				</div>
			</div>
		</div>
	</div>
</template>
<!--suppress HtmlUnknownAttribute -->
<style scoped>
	{{this}} {
		--f7-navbar-large-title-height:88px;
	}
	.links-list a {
		white-space: normal;
	}
	.list .item-title {
		white-space: normal;
		display: -webkit-box;
		-webkit-line-clamp: 2;
		-webkit-box-orient: vertical;
	}

	.date-section p {
		margin: 0;
	}

	.date-section p.weekday {
		font-size: 24px;
		margin: 0;
	}

	em {
		color: red;
		font-style: normal;
	}

	.day-saints-text a {
		/*text-decoration: none;*/
	}

	.day-saints-text strong {
	}

	.day-saints-text em {
		font-style: normal;
		font-size: 1.25em;
		color: red;
	}

	.day-saints-text img {
		height: 20px;
		vertical-align: middle;
		margin-top: -3px;
		margin-right: 3px;
	}

	.day-saints-icon  {
		display: flex;
	}

	.day-saints-icon .skeleton-block {
		--f7-skeleton-color: #c2c2c2;
		position: absolute;
		top: 0;
		left: calc(var(--f7-block-padding-horizontal) + var(--f7-safe-area-left));
		right: calc(var(--f7-block-padding-horizontal) + var(--f7-safe-area-left));
		height: 100%;
		width: auto;
		z-index: 1;
	}

	.day-saints-icon .item-media {
		width: 65%; /* max- */
		height: 250px;
		flex-shrink: 0;
	}

	/*
	.day-saints-icon img {
		height: 100%;
		object-fit: contain;
	}
	*/

	.day-saints-icon .item-text {
		padding-left: 10px;
		align-self: center;
		font-size: 14px;
		flex-shrink: 1;
	}

	@media (min-width: 768px) {
		.day-saints-icon .item-text {
			padding-left: 15px;
			font-size: 18px;
		}

		.day-saints-icon .item-media {
			height: 380px;
		}
	}

	.day-saints-icon .item-text:first-letter {
		text-transform: uppercase;
	}

	@media (min-width: 768px) {
		.day-saints-text img {
			height: 25px;
			vertical-align: middle;
			margin-top: -5px;
			margin-right: 5px;
		}


	}
</style>
<!--suppress JSAnnotator -->
<script>
	import Framework7 from 'framework7';
	import { format, parse, addDays, subDays } from '../js/utils/date-utils.js';
	import { upperFirst } from 'lodash-es';
	import dataManager from '../js/data/manager.js';
	import { getUrl } from '../js/image-manager.js';

	let app;

	export default {
		on: {
			pageAfterIn(e, page) {
				// this.$router.navigate('/days/20190428', {});
			},
		},
		async data() {
			app = this.$app;
			let prayers = dataManager.cache.prayers,
				dayCode = this.$route.params.id,
				day = Object.assign({}, this.day);

			day.text = (day.text)
				.replace(/href="E(\d+)"/g, 'href="/prayers/text/$1"')
			;

			day.text = (day.text)
				.replace(/\/local\/templates\/valaam\/images\/(ideograph-\d\.png)/ig, 'images\/$1')
			;

			day.picture = await getUrl({
				s: this.day.picture,
				m: this.day.picture_2x
			});
			day.picture_full = await getUrl({
				s: this.day.picture_3x,
				sOffline: this.day.picture,
				mOffline: this.day.picture_2x
			});

			day.picture_desc = app.methods.hyphenate(day.picture_desc);

			day.readers_text = day.readers_text.replace(/\^(\d+)/g, '<sup>$1</sup>');

			day.parabel_short = day.parabel
				.replace(/<\/?[^>]+>/gi, '')
				.slice(0, 300)
			;

			if (!day.prayers.taks) {
				day.prayers.taks = [];
			}

			if (day.synaxarion) {
				day.synaxarion = prayers.e.find(
					(e) => e.id === day.synaxarion
				);
			}

			let oldstyleDate = subDays(parse(day.code), 13);
			let newstyleDate = parse(day.code);
			let dayOfWeek = upperFirst(format(newstyleDate, 'EEEE'));

			day.subtitle = format(oldstyleDate, 'd MMMM по старому стилю');
			day.title = format(newstyleDate, `d MMMM yyyy г. ${dayOfWeek}`);
			day.full_title = format(oldstyleDate, 'd MMMM / ') +
											 day.title;

			return {
				dayCode,
				day,
				dayPrev: format(subDays(parse(day.code), 1)),
				dayNext: format(addDays(parse(day.code), 1)),
				searchMode: this.$route.query.mode === 'search'
			};
		}
	};
</script>
